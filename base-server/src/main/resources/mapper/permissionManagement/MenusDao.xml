<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gosaint.dao.menus.MenusDao">
    
    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="com.gosaint.model.menus.Menus">
        <result column="menu_id" property="menuId"/>
        <result column="menu_name" property="menuName"/>
        <result column="icon" property="icon"/>
        <result column="path" property="path"/>
        <result column="parent_id" property="parentId"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="is_visible" property="isVisible"/>
        <result column="menu_type" property="menuType"/>
        <result column="permission_key" property="permissionKey"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>
    
    <!-- 树形结构结果映射 -->
    <resultMap id="TreeResultMap" type="com.gosaint.model.menus.Menus" extends="BaseResultMap">
        <collection property="children" ofType="com.gosaint.model.menus.Menus" select="selectByParentId" column="menu_id"/>
    </resultMap>

    <!-- 插入菜单 -->
    <insert id="insert" parameterType="com.gosaint.model.menus.Menus">
        INSERT INTO menus (
            menu_id, 
            menu_name, 
            icon, 
            path,
            parent_id,
            sort_order,
            is_visible,
            menu_type,
            permission_key,
            created_at
        ) VALUES (
            #{menuId}, 
            #{menuName}, 
            #{icon}, 
            #{path},
            #{parentId},
            #{sortOrder},
            #{isVisible},
            #{menuType},
            #{permissionKey},
            #{createdAt}
        )
    </insert>

    <!-- 根据ID查询菜单 -->
    <select id="selectById" parameterType="String" resultMap="BaseResultMap">
        SELECT * FROM menus WHERE menu_id = #{menuId}
    </select>

    <!-- 根据父菜单ID查询子菜单 -->
    <!-- 使用 TreeResultMap 以便递归装配多级 children -->
    <select id="selectByParentId" parameterType="String" resultMap="TreeResultMap">
        SELECT * FROM menus WHERE parent_id = #{value} ORDER BY sort_order ASC
    </select>

    <!-- 查询所有菜单（树形结构） -->
    <select id="selectAllMenus" resultMap="TreeResultMap">
        SELECT * FROM menus WHERE parent_id='0' ORDER BY sort_order ASC
    </select>

    <!-- 更新菜单 -->
    <update id="update" parameterType="com.gosaint.model.menus.Menus">
        UPDATE menus
        SET 
            menu_name = #{menuName},
            icon = #{icon},
            path = #{path},
            parent_id = #{parentId},
            sort_order = #{sortOrder},
            is_visible = #{isVisible},
            menu_type = #{menuType},
            permission_key = #{permissionKey}
        WHERE menu_id = #{menuId}
    </update>

    <!-- 删除菜单 -->
    <delete id="delete" parameterType="String">
        DELETE FROM menus WHERE menu_id = #{menuId}
    </delete>
    
    <!-- 根据角色ID查询菜单列表 -->
    <select id="selectMenusByRoleId" parameterType="String" resultMap="TreeResultMap">
        SELECT DISTINCT m.* FROM menus m
        JOIN role_permissions rp ON m.permission_key = rp.permission_id
        WHERE rp.role_id = #{roleId} AND m.is_visible = TRUE
        ORDER BY m.sort_order ASC
    </select>
</mapper>